-- Fix compliance_cases schema issues
-- V12: Resolves type mismatches that prevent Hibernate from starting

-- Drop the problematic foreign key constraint if it exists
-- This FK was auto-generated by Hibernate but is incompatible (varchar vs bigint)
ALTER TABLE compliance_cases DROP CONSTRAINT IF EXISTS fkd6q3rjryrv9ya83t9ov84csbj;

-- Also drop any other auto-generated FK constraints on merchant_id
DO $$
DECLARE
    r RECORD;
BEGIN
    FOR r IN (
        SELECT conname 
        FROM pg_constraint 
        WHERE conrelid = 'compliance_cases'::regclass 
        AND contype = 'f'
        AND pg_get_constraintdef(oid) LIKE '%merchant_id%'
    )
    LOOP
        EXECUTE 'ALTER TABLE compliance_cases DROP CONSTRAINT IF EXISTS ' || quote_ident(r.conname);
    END LOOP;
END $$;

-- Fix resolved_by column if it's the wrong type (convert to bigint with USING clause)
-- First check if resolved_by exists and needs conversion
DO $$
BEGIN
    -- Check if the column exists and is not already bigint
    IF EXISTS (
        SELECT 1 FROM information_schema.columns 
        WHERE table_name = 'compliance_cases' 
        AND column_name = 'resolved_by'
        AND data_type != 'bigint'
    ) THEN
        ALTER TABLE compliance_cases 
        ALTER COLUMN resolved_by TYPE BIGINT USING resolved_by::bigint;
    END IF;
END $$;

-- Ensure psp_id column exists
ALTER TABLE compliance_cases ADD COLUMN IF NOT EXISTS psp_id BIGINT;

-- CREATE INDEX IF NOT EXISTS on merchant_id if not exists (no FK, just for filtering)
CREATE INDEX IF NOT EXISTS idx_compliance_cases_merchant_id ON compliance_cases(merchant_id);

-- CREATE INDEX IF NOT EXISTS on psp_id if not exists
CREATE INDEX IF NOT EXISTS idx_compliance_cases_psp_id ON compliance_cases(psp_id);

